<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #005f00; text-decoration-color: #005f00}
.r2 {font-weight: bold}
.r3 {color: #000080; text-decoration-color: #000080; font-weight: bold}
.r4 {color: #87af00; text-decoration-color: #87af00; font-weight: bold}
.r5 {color: #005f00; text-decoration-color: #005f00; font-weight: bold}
.r6 {color: #7f7f7f; text-decoration-color: #7f7f7f; font-weight: bold}
.r7 {color: #000080; text-decoration-color: #000080; font-weight: bold; font-style: italic}
.r8 {color: #87af00; text-decoration-color: #87af00; font-weight: bold; font-style: italic}
.r9 {color: #005f00; text-decoration-color: #005f00; font-weight: bold; font-style: italic}
.r10 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r11 {color: #000080; text-decoration-color: #000080}
.r12 {color: #87af00; text-decoration-color: #87af00}
.r13 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r14 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r15 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r16 {background-color: #f8f8f8}
.r17 {color: #3d7b7b; text-decoration-color: #3d7b7b; background-color: #f8f8f8; font-style: italic}
.r18 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r19 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r20 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r21 {color: #a45a77; text-decoration-color: #a45a77; background-color: #f8f8f8; font-weight: bold}
.r22 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r23 {color: #800000; text-decoration-color: #800000; font-weight: bold}
.r24 {color: #000080; text-decoration-color: #000080; text-decoration: underline}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<body>
    <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><code style="font-family:inherit">                          Memory usage: <span class="r1">▁▁▁▂▂▃▃▃▃▄▄▄▆▄▄▄▄▅▆▆▇▇█████</span> (max: 492.328 MB, growth rate:  44%)                           
                     /root/rscratch/nnsight_activation_patch.py: % of time = 100.00% (46.058s) out of 46.058s.                     
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/root/rscratch/nnsight_activation_patch.py         </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">       </span>│<span class="r11">    3% </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  99%  </span>│<span class="r1">   30M </span>│<span class="r1">▁▁▁   3%       </span>│<span class="r12">    10 </span>│<span class="r13">import</span><span class="r14"> </span><span class="r15">plotly.express</span><span class="r14"> </span><span class="r13">as</span><span class="r14"> </span><span class="r15">px</span><span class="r16">                       </span>  
 <span class="r10">    2 </span>│<span class="r11">    4% </span>│<span class="r11">    4% </span>│<span class="r11">   1% </span>│<span class="r12">       </span>│<span class="r1">  69%  </span>│<span class="r1">  160M </span>│<span class="r1">▁▁▁▁▁▁▁▁▁  14% </span>│<span class="r12">    18 </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">nnsight</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> LanguageModel, util</span><span class="r16">           </span>  
 <span class="r10">    3 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r13">from</span><span class="r14"> </span><span class="r15">nnsight.tracing.Proxy</span><span class="r14"> </span><span class="r13">import</span><span class="r14"> Proxy</span><span class="r16">           </span>  
 <span class="r10">    4 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    5 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r17"># Load gpt2</span><span class="r16">                                       </span>  
 <span class="r10">    6 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">   1% </span>│<span class="r12">       </span>│<span class="r1">  69%  </span>│<span class="r1">   30M </span>│<span class="r1">▁▁▁▁▁   3%     </span>│<span class="r12">     1 </span>│<span class="r14">model </span><span class="r18">=</span><span class="r14"> LanguageModel(</span><span class="r19">&quot;gpt2&quot;</span><span class="r14">, device_map</span><span class="r18">=</span><span class="r19">&quot;cuda:0&quot;</span><span class="r14">)</span>  
 <span class="r10">    7 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">    8 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">clean_prompt </span><span class="r18">=</span><span class="r14"> </span><span class="r19">&quot;&lt;|endoftext|&gt;After John and Mary w</span>  
 <span class="r10">    9 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">corrupted_prompt </span><span class="r18">=</span><span class="r14"> </span><span class="r19">&quot;&lt;|endoftext|&gt;After John and Ma</span>  
 <span class="r10">   10 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   11 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">correct_index </span><span class="r18">=</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">tokenizer(</span><span class="r19">&quot; John&quot;</span><span class="r14">)[</span><span class="r19">&quot;input_id</span>  
 <span class="r10">   12 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">incorrect_index </span><span class="r18">=</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">tokenizer(</span><span class="r19">&quot; Mary&quot;</span><span class="r14">)[</span><span class="r19">&quot;input_</span>  
 <span class="r10">   13 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   14 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r20">print</span><span class="r14">(</span><span class="r19">f&quot;&#x27; John&#x27;: </span><span class="r21">{</span><span class="r14">correct_index</span><span class="r21">}</span><span class="r19">&quot;</span><span class="r14">)</span><span class="r16">                </span>  
 <span class="r10">   15 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r20">print</span><span class="r14">(</span><span class="r19">f&quot;&#x27; Mary&#x27;: </span><span class="r21">{</span><span class="r14">incorrect_index</span><span class="r21">}</span><span class="r19">&quot;</span><span class="r14">)</span><span class="r16">              </span>  
 <span class="r10">   16 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   17 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r17"># Enter nnsight tracing context</span><span class="r16">                   </span>  
 <span class="r10">   18 </span>│<span class="r11">       </span>│<span class="r11">    2% </span>│<span class="r11">   2% </span>│<span class="r12">       </span>│<span class="r1">   2%  </span>│<span class="r1">  270M </span>│<span class="r1">▃▃▃▄▄▅▆▆▆  78% </span>│<span class="r12">     3 </span>│<span class="r13">with</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">forward() </span><span class="r13">as</span><span class="r14"> runner:</span><span class="r16">                   </span>  
 <span class="r10">   19 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17"># Clean run</span><span class="r16">                                   </span>  
 <span class="r10">   21 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> runner</span><span class="r18">.</span><span class="r14">invoke(clean_prompt) </span><span class="r13">as</span><span class="r14"> invoker:</span><span class="r16">  </span>  
 <span class="r10">   22 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        clean_tokens </span><span class="r18">=</span><span class="r14"> invoker</span><span class="r18">.</span><span class="r14">input[</span><span class="r19">&quot;input_ids&quot;</span><span class="r14">][</span>  
 <span class="r10">   23 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   24 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># Get hidden states of all layers in the n</span>  
 <span class="r10">   25 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># We index the output at 0 because it&#x27;s a </span>  
 <span class="r10">   26 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># No need to call .save() as we don&#x27;t need</span>  
 <span class="r10">   27 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     2 </span>│<span class="r14">        clean_hs </span><span class="r18">=</span><span class="r14"> [model</span><span class="r18">.</span><span class="r14">transformer</span><span class="r18">.</span><span class="r14">h[layer_idx]</span>  
 <span class="r10">   28 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   29 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># Get logits from the lm_head.</span><span class="r16">            </span>  
 <span class="r10">   30 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        clean_logits </span><span class="r18">=</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">lm_head</span><span class="r18">.</span><span class="r14">output</span><span class="r16">       </span>  
 <span class="r10">   31 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   32 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># Calculate the difference between the cor</span>  
 <span class="r10">   33 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        clean_logit_diff </span><span class="r18">=</span><span class="r14"> (clean_logits[</span><span class="r18">0</span><span class="r14">, </span><span class="r18">-1</span><span class="r14">, co</span>  
 <span class="r10">   34 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   35 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17"># Corrupted run</span><span class="r16">                               </span>  
 <span class="r10">   36 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">with</span><span class="r14"> runner</span><span class="r18">.</span><span class="r14">invoke(corrupted_prompt) </span><span class="r13">as</span><span class="r14"> invoke</span>  
 <span class="r10">   37 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        corrupted_logits </span><span class="r18">=</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">lm_head</span><span class="r18">.</span><span class="r14">output</span><span class="r16">   </span>  
 <span class="r10">   38 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   39 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># Calculate the difference between the cor</span>  
 <span class="r10">   40 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        corrupted_logit_diff </span><span class="r18">=</span><span class="r14"> (</span><span class="r16">                  </span>  
 <span class="r10">   41 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            corrupted_logits[</span><span class="r18">0</span><span class="r14">, </span><span class="r18">-1</span><span class="r14">, correct_index]</span>  
 <span class="r10">   42 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        )</span><span class="r18">.</span><span class="r14">save()</span><span class="r16">                                  </span>  
 <span class="r10">   43 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   44 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ioi_patching_results </span><span class="r18">=</span><span class="r14"> []</span><span class="r16">                     </span>  
 <span class="r10">   45 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   46 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r17"># Iterate through all the layers</span><span class="r16">              </span>  
 <span class="r10">   47 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    </span><span class="r13">for</span><span class="r14"> layer_idx </span><span class="r22">in</span><span class="r14"> </span><span class="r20">range</span><span class="r14">(</span><span class="r20">len</span><span class="r14">(model</span><span class="r18">.</span><span class="r14">transformer</span><span class="r18">.</span><span class="r14">h</span>  
 <span class="r10">   48 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        _ioi_patching_results </span><span class="r18">=</span><span class="r14"> []</span><span class="r16">                </span>  
 <span class="r10">   49 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   50 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r17"># Iterate through all tokens</span><span class="r16">              </span>  
 <span class="r10">   51 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        </span><span class="r13">for</span><span class="r14"> token_idx </span><span class="r22">in</span><span class="r14"> </span><span class="r20">range</span><span class="r14">(</span><span class="r20">len</span><span class="r14">(clean_tokens)):</span>  
 <span class="r10">   52 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   53 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">            </span><span class="r17"># Patching corrupted run at given laye</span>  
 <span class="r10">   54 </span>│<span class="r23">   36%</span><span class="r11"> </span>│<span class="r23">   11%</span><span class="r11"> </span>│<span class="r11">   2% </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     3 </span>│<span class="r14">            </span><span class="r13">with</span><span class="r14"> runner</span><span class="r18">.</span><span class="r14">invoke(corrupted_prompt) </span><span class="r13">a</span>  
 <span class="r10">   55 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   56 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17"># Apply the patch from the clean h</span>  
 <span class="r10">   57 </span>│<span class="r11">    7% </span>│<span class="r11">    3% </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">    15 </span>│<span class="r14">                model</span><span class="r18">.</span><span class="r14">transformer</span><span class="r18">.</span><span class="r14">h[layer_idx]</span><span class="r18">.</span><span class="r14">out</span>  
 <span class="r10">   58 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   59 </span>│<span class="r11">    1% </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                patched_logits </span><span class="r18">=</span><span class="r14"> model</span><span class="r18">.</span><span class="r14">lm_head</span><span class="r18">.</span><span class="r14">out</span>  
 <span class="r10">   60 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   61 </span>│<span class="r11">    5% </span>│<span class="r11">    2% </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     8 </span>│<span class="r14">                patched_logit_diff </span><span class="r18">=</span><span class="r14"> patched_logit</span>  
 <span class="r10">   62 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   63 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">                </span><span class="r17"># Calculate the improvement in the</span>  
 <span class="r10">   64 </span>│<span class="r11">    5% </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     3 </span>│<span class="r14">                patched_result </span><span class="r18">=</span><span class="r14"> (patched_logit_di</span>  
 <span class="r10">   65 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   66 </span>│<span class="r11">    2% </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">     7 </span>│<span class="r14">                _ioi_patching_results</span><span class="r18">.</span><span class="r14">append(patch</span>  
 <span class="r10">   67 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   68 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">        ioi_patching_results</span><span class="r18">.</span><span class="r14">append(_ioi_patching_</span>  
 <span class="r10">   69 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   70 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   71 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r20">print</span><span class="r14">(</span><span class="r19">f&quot;Clean logit difference: </span><span class="r21">{</span><span class="r14">clean_logit_diff</span><span class="r18">.</span>  
 <span class="r10">   72 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r20">print</span><span class="r14">(</span><span class="r19">f&quot;Corrupted logit difference: </span><span class="r21">{</span><span class="r14">corrupted_log</span>  
 <span class="r10">   73 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   74 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">ioi_patching_results </span><span class="r18">=</span><span class="r14"> util</span><span class="r18">.</span><span class="r14">apply(ioi_patching_res</span>  
 <span class="r10">   75 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   76 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">clean_tokens </span><span class="r18">=</span><span class="r14"> [model</span><span class="r18">.</span><span class="r14">tokenizer</span><span class="r18">.</span><span class="r14">decode(token) </span><span class="r13">for</span><span class="r14"> </span>  
 <span class="r10">   77 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">token_labels </span><span class="r18">=</span><span class="r14"> [</span><span class="r19">f&quot;</span><span class="r21">{</span><span class="r14">token</span><span class="r21">}</span><span class="r19">_</span><span class="r21">{</span><span class="r14">index</span><span class="r21">}</span><span class="r19">&quot;</span><span class="r14"> </span><span class="r13">for</span><span class="r14"> index, toke</span>  
 <span class="r10">   78 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   79 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  95%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">     1 </span>│<span class="r14">fig </span><span class="r18">=</span><span class="r14"> px</span><span class="r18">.</span><span class="r14">imshow(</span><span class="r16">                                  </span>  
 <span class="r10">   80 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    ioi_patching_results,</span><span class="r16">                         </span>  
 <span class="r10">   81 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    color_continuous_midpoint</span><span class="r18">=0.0</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">   82 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    color_continuous_scale</span><span class="r18">=</span><span class="r19">&quot;RdBu&quot;</span><span class="r14">,</span><span class="r16">                </span>  
 <span class="r10">   83 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    labels</span><span class="r18">=</span><span class="r14">{</span><span class="r19">&quot;x&quot;</span><span class="r14">: </span><span class="r19">&quot;Position&quot;</span><span class="r14">, </span><span class="r19">&quot;y&quot;</span><span class="r14">: </span><span class="r19">&quot;Layer&quot;</span><span class="r14">},</span><span class="r16">       </span>  
 <span class="r10">   84 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    x</span><span class="r18">=</span><span class="r14">token_labels,</span><span class="r16">                               </span>  
 <span class="r10">   85 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">    title</span><span class="r18">=</span><span class="r19">&quot;Normalized Logit Difference After Patch</span>  
 <span class="r10">   86 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r14">)</span><span class="r16">                                                 </span>  
 <span class="r10">   87 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
 <span class="r10">   88 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">  95%  </span>│<span class="r1">   10M </span>│<span class="r1">▁              </span>│<span class="r12">       </span>│<span class="r14">fig</span><span class="r18">.</span><span class="r14">show()</span><span class="r16">                                        </span>  
 <span class="r10">   89 </span>│<span class="r11">       </span>│<span class="r11">       </span>│<span class="r11">      </span>│<span class="r12">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r12">       </span>│<span class="r16">                                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top AVERAGE memory consumption, by line:
<span class="r1">(1)    88:    10 MB</span>                                                                                                                 
Top PEAK memory consumption, by line:
<span class="r1">(1)    18:   270 MB</span>                                                                                                                 
<span class="r1">(2)     2:   160 MB</span>                                                                                                                 
<span class="r1">(3)     6:    30 MB</span>                                                                                                                 
<span class="r1">(4)     1:    30 MB</span>                                                                                                                 
<span class="r1">(5)    88:    10 MB</span>                                                                                                                 
generated by the <a class="r24" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</code></pre>
</body>
</html>
